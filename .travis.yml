sudo: required
services:
  - docker
language: node_js
node_js:
  - '5'
  - '4'
  - '0.12'
  - '0.10'
env:
  matrix:
    - CXX=g++-4.8
  global:
    - COMMIT=${TRAVIS_COMMIT::8}
    - secure: "KPf6trtYLBDc2S/fF7H4VkNOAQ2Gc9sFj3v8aHOhNWDagACEHaPjIZdr3MGmzXji2EyQqtm6SxBxzdMbe1BNY5GRALgGI2fSyra+VwjhUeOB/UJ8oZuxhqnywbF77lbZgUYK/kOWHgCKGQxRsVZyytgK2CihOwPwzSp/CWUhBjlyjtDpUOMJXfc0USg05imR9LcwdW9o84uXGyI3XwHhqsA5szlu09Oxz+O//TMCHobb8o9b13N8Oxhdu9mgzynXCEo7TG4rwbmx2t7ymfM0TfEqfEsOOQ/A7iPJ4lxQ+FKGoKaqfITuZtUmzd4RaCK8zRVg/dYbXX2qF/RWRBKwIAfBLNLYYdFxleaBaNgGGyQw8TpNkm80u5ilmIDCrw79m0MqePZXcL4pdfRC9PBE2PO55tX/Podhk9HKovixvB4qxUj3Y45ORtSE2TO78W3Cs54JTQVNh4xz8Tzp67DWwNXN5XnwkVyvRugaCHV1gUuJWuJTUr6Bdoad9vid+GUKqNoBlTTgkjfc0/TDSuDFnAbnhdga4xFoFLnpTDpCaZrr1NWfhVCepGqY7I4qLcie/Bobpr6n8UuBRg6devdcBZJxAYKyC4SkfqfkJe36TmTViz7GCs698CAPteJ2ypifeERT9zYu0JYeofEi49bPxevaaFICxzUE2WIAlGeGIw0=" # DOCKER_EMAIL
    - secure: "Xh5xnUckiGwr3pcl44c8A91p2AyhJXMpGzDPpTk+63ZeM0nDnUh1/1StqW+5Bfx24MI6HtkOiGa7zTn8HbDMWXVN7s+eZ0eC28GI63EsKyivsMyylR+mwMKsAHcxbfZvFaDJiYE/s1FXXVdIr3PpNVxlncbuZiTQ+i+sr4iD+B14UV+GTwgbpyNEF2jSK+MlV0XAn6AK4kc6fd3Zx2guG9Kv8slwFcK7Kwjpa4C+t0ZX85wiqlPBhC42nhx6eRUwWbf/4rySd/4RhHXan+zsBWBjUHLhjzMvwsahqPg0yBzkFoZ3ozUQqv9NhmyjEANCAAj1vcOoFZ0nikgfR1WqeMEcKfTFbV0QVfqnEyYHN2ZUmvOzv2gih26gHaY7E2Dte6u96CSv5TgwYtiCBZzc0vHO8p2+heLfourhqdQhanElq4nthBffKJled5dOcq6UAINK85ZwzS+7EZG79idGETR7vvCiaLLuhCn4kFdo1fLOCTQ+FJAOYw3uSk6n1YlNbxNJ7RwykgRB/9MgbJHc9o67C/Y3NEzBRErSctqfZ9Rg6gICM8dkwoBh0652FDn4E/TCkpfKbpTkRkJoFzRxe9joFTYvkt+fIYwokyajgt/qlpb6XQiFiUqdlWcWcYDNbBSnIMfH4L61ktMtCCcv85Iw98d1bxi93r/UdyhWOuQ=" # DOCKER_USER
    - secure: "d3kdHpD4+tgCBJ90bOya+d5ZaZnXqqxjTPV8m+u3TM0a/eIejp3l7HU45Dql01lX9wfhlMRUCPZIhS2/D8MHwPBwAfLKZ3uafxkGqj896a47mTQiVlh2b7cXQ4ha9231dZvB1NxMXGxRYYuJq79g8ccvZjWyt1Zho5QfjWlqdF06nYoN2M+boV1nH3Ufr981syGteABnKBAAoRC41TJdQbx6Lr7CKJPGoA/P5uNeDD/KMYPZb4EOGGG0XM7lHi1iyp0lHkH37s0nZ7EcJ/NfkpX8zAY7mv4kvxljoPwEFWj8bHBTrzZudSheRki7Y96T0Gg5n1F5y8K0ot9qfDAtQWEyMCu0o9TnrUuDWFxYGVgUDX3sgRbxEVCZ1dIHGQv+37zxL6M5N59jTpIs1BEbhG+vu36Y3x8Rdxjw+5AunZ9LVN/dDRKSW0H0VHyRPXb6mhmQmEGo6PL0hzO4Kmh2t0D44pDp8+U57ZvoESFLDUZu0zHtYjUQEEviA1dxJSJHjzpDZ4QN3S0W35FCT0axS5pqYhFYS9TJmwmy0sY9MiUHAgrfCrwPPgzY8uAEKxvwH13vEYnHN4U4Lr0P99Eplv2scPcLSa7uUNQjwWISu1Jr03LSWKbmy+oDjSXKcdL6ON2tfAllZFsnBZqaKEvvceaXWWwMyPw/X4qteR1EExE=" # DOCKER_PASS
addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - g++-4.8
after_success:
  - npm run coveralls
  - npm run coverage-clean
  - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
  - export DOCKER_REPO=cheton/cnc
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH; fi`
  - docker build -f Dockerfile -t $DOCKER_REPO:$COMMIT .
  - docker tag $DOCKER_REPO:$COMMIT $DOCKER_REPO:$TAG
  - docker tag $DOCKER_REPO:$COMMIT $DOCKER_REPO:travis-$TRAVIS_BUILD_NUMBER
  - if [ ! -z "$TRAVIS_TAG" ]; then docker tag $DOCKER_REPO:$COMMIT $DOCKER_REPO:$TRAVIS_TAG; fi
  - docker push $DOCKER_REPO
